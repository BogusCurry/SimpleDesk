<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>SimpleDeskTeam:SimpleDesk</id>
	<version>1.1 rev753</version>

	<file name="$sourcedir/Admin.php"><!-- adds the navbar links to the admin panel -->
		<operation><!-- prepend SimpleDesk's ACP helper functions to the list of places to search -->
			<search position="replace"><![CDATA[// This is a special array of functions that contain setting data - we query all these to simply pull all setting bits!
	$settings_search = array(]]></search>
			<add><![CDATA[// Add SimpleDesk functions
	$settings_search = array();
	$settings_search[] = array('shd_modify_display_options', 'area=helpdesk_options;sa=display');
	$settings_search[] = array('shd_modify_posting_options', 'area=helpdesk_options;sa=posting');
	$settings_search[] = array('shd_modify_admin_options', 'area=helpdesk_options;sa=admin');
	$settings_search[] = array('shd_modify_standalone_options', 'area=helpdesk_options;sa=standalone');
	$settings_search[] = array('shd_modify_actionlog_options', 'area=helpdesk_options;sa=actionlog');
	$settings_search[] = array('shd_modify_notifications_options', 'area=helpdesk_options;sa=notifications');

	if (!empty($modSettings['shd_hook_hdadminoptssrch']))
	{
		$functions = explode(',', $modSettings['shd_hook_hdadminoptssrch']);
		foreach ($functions as $function)
		{
			if (is_callable($function))
				$function($settings_search); // by reference!
		}
	}

	$search_entries = count($settings_search);

	// This is a special array of functions that contain setting data - we query all these to simply pull all setting bits!
	$settings_search += array(
		$search_entries =>]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Load.php"><!-- globally figure out if Helpdesk is enabled; note this doesn't get pushed into settings table :) -->
		<operation>
			<search position="after"><![CDATA[	// Build the list of boards they WANT to see.]]></search>
			<add><![CDATA[	// Are we helping people today? If so, bootstrap SimpleDesk.
	shd_init();
	
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Profile.php"><!-- Add the profile section -->
		<operation><!-- Add the SimpleDesk section to the Profile menu -->
			<search position="after"><![CDATA[	// Is there an updated message to show?]]></search>
			<add><![CDATA[	// SimpleDesk sections. Added here after the initial cleaning is done, so that we can do our own permission checks without arguing with SMF's system (so much)
	if (!empty($modSettings['helpdesk_active']))
	{
		shd_load_language('SimpleDeskProfile');

		// Put it here so we can reuse it for the left menu a bit
		$context['helpdesk_menu'] = array(
			'title' => $txt['shd_profile_area'],
			'areas' => array(
				'helpdesk' => array(
					'label' => $txt['shd_profile_main'],
					'file' => 'sd_source/SimpleDesk-Profile.php',
					'function' => 'shd_profile_main',
					'enabled' => shd_allowed_to('shd_view_profile_any') || ($context['user']['is_owner'] && shd_allowed_to('shd_view_profile_own')),
				),
				'hd_prefs' => array(
					'label' => $txt['shd_profile_preferences'],
					'file' => 'sd_source/SimpleDesk-Profile.php',
					'function' => 'shd_profile_main',
					'enabled' => shd_allowed_to('shd_view_preferences_any') || ($context['user']['is_owner'] && shd_allowed_to('shd_view_preferences_own')),
				),
				'hd_showtickets' => array(
					'label' => $txt['shd_profile_show_tickets'],
					'file' => 'sd_source/SimpleDesk-Profile.php',
					'function' => 'shd_profile_main',
					'enabled' => ($context['user']['is_owner'] && shd_allowed_to('shd_view_ticket_own')) || shd_allowed_to('shd_view_ticket_any'),
				),
				'hd_permissions' => array(
					'label' => $txt['shd_profile_permissions'],
					'file' => 'sd_source/SimpleDesk-Profile.php',
					'function' => 'shd_profile_main',
					'enabled' => shd_allowed_to('admin_helpdesk'),
				),
				'hd_actionlog' => array(
					'label' => $txt['shd_profile_actionlog'],
					'file' => 'sd_source/SimpleDesk-Profile.php',
					'function' => 'shd_profile_main',
					'enabled' => empty($modSettings['shd_disable_action_log']) && (shd_allowed_to('shd_view_profile_log_any') || ($context['user']['is_owner'] && shd_allowed_to('shd_view_profile_log_own'))),
				),
			),
		);

		// Kill the existing profile menu but save it in a temporary place first.
		$old_profile_areas = $profile_areas;
		$profile_areas = array();

		// Now, where we add this depends very much on what mode we're in. In HD only mode, we want our menu first before anything else.
		if (!empty($modSettings['shd_helpdesk_only']))
		{
			$profile_areas['helpdesk'] = $context['helpdesk_menu'];
			$profile_areas += $old_profile_areas;
		}
		else
		// In non HD only, put it before the editing stuff menu
		{
			foreach ($old_profile_areas as $area => $details)
			{
				if ($area == 'edit_profile')
					$profile_areas['helpdesk'] = $context['helpdesk_menu'];
				$profile_areas[$area] = $details;
			}
		}

		// Now engage any hooks.
		if (!empty($modSettings['shd_hook_profilemenu']))
		{
			$functions = explode(',', $modSettings['shd_hook_profilemenu']);
			foreach ($functions as $function)
			{
				if (is_callable($function))
					$function($profile_areas); // this should be picked up by reference in the called function or it won't do anything!
			}
		}
	}

]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs.php"><!-- reconfigure the main menu somewhat -->
		<operation><!-- expand the quote link= parameter -->
			<search position="before"><![CDATA[(?:topic|threadid)=[\dmsg#\./]{1,40}(?:;start=[\dmsg#\./]{1,40})?]]></search>
			<add><![CDATA[|action=helpdesk;sa=ticket;ticket=[\dmsg#\./]{1,40}(?:;start=[\dmsg#\./]{1,40})?]]></add>
		</operation>
		<operation><!-- Force the log of disabled tags to be reset if we're calling it in such a condition as it is being re-evaluated anyway -->
			<search position="before"><![CDATA[		if (!empty($modSettings['disabledBBC']))
		{]]></search>
			<add><![CDATA[
			$disabled = array(); // SimpleDesk added! Forces reset of $disabled if we're calling in an unusual way
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Profile-Modify.php"><!-- Ensure things get uncached if we change groups (which means permissions) -->
		<operation>
			<search position="after"><![CDATA[// The account page allows the change of your id_group - but not to a protected group!]]></search>
			<add><![CDATA[	// Ensure we uncache stuff that might change in the helpdesk
	shd_clear_active_tickets($context['id_member']);

]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManagePermissions.php"><!-- disable permissions that don't apply in SA mode -->
		<operation>
			<search position="after"><![CDATA[	// We need to know what permissions we can't give to guests.]]></search>
			<add><![CDATA[	// Are we in SD only mode? If so... hoo boy, we gots some purging to do.
	if ($modSettings['helpdesk_active'] && !empty($modSettings['shd_helpdesk_only']))
	{
		$perms_disable = array(
			'membergroup' => array(
				'view_stats',
				'who_view',
				'search_posts',
				'karma_edit',
				'calendar_view',
				'calendar_post',
				'calendar_edit',
				'manage_boards',
				'manage_attachments',
				'manage_smileys',
				'edit_news',
				'access_mod_center',
				'moderate_forum',
				'send_mail',
				'issue_warning',
				'shd_ticket_to_topic', // yes, even our own, makes sense to reuse what we have here
				'shd_topic_to_ticket',
			),
			'board' => array(
				'moderate_board',
				'approve_posts',
				'post_new',
				'post_unapproved_topics',
				'post_unapproved_replies',
				'post_reply',
				'merge_any',
				'split_any',
				'send_topic',
				'make_sticky',
				'move',
				'lock',
				'remove',
				'modify_replies',
				'delete_replies',
				'announce_topic',
				'delete',
				'modify',
				'report_any',
				'poll_view',
				'poll_vote',
				'poll_post',
				'poll_add',
				'poll_edit',
				'poll_lock',
				'poll_remove',
				'mark_any_notify',
				'mark_notify',
				'view_attachments',
				'post_unapproved_attachments',
				'post_attachment',
			),
		);
		// that's the generic stuff, now for specific options
		if (!empty($modSettings['shd_disable_pm']))
		{
			$perms_disable['membergroup'][] = 'pm_read';
			$perms_disable['membergroup'][] = 'pm_send';
		}

		foreach ($perms_disable as $group => $perm_list)
			foreach ($perm_list as $perm)
				if (isset($permissionList[$group][$perm]))
					unset($permissionList[$group][$perm]);
	}

]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Help.php"><!-- load the admin help strings -->
		<operation>
			<search position="replace"><![CDATA[	loadLanguage('Help');]]></search>
			<add><![CDATA[	loadLanguage('Help');
	shd_load_language('SimpleDeskAdmin');]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManagePosts.php"><!-- at the same time we modify the post settings, make sure we check and update SD's if necessary -->
		<operation>
			<search position="before"><![CDATA[$smcFunc['db_change_column']('{db_prefix}messages', 'body', array('type' => 'mediumtext'));]]></search>
			<add><![CDATA[
					$smcFunc['db_change_column']('{db_prefix}helpdesk_ticket_replies', 'body', array('type' => 'mediumtext'));]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[$smcFunc['db_change_column']('{db_prefix}messages', 'body', array('type' => 'text'));]]></search>
			<add><![CDATA[
					$smcFunc['db_change_column']('{db_prefix}helpdesk_ticket_replies', 'body', array('type' => 'text'));]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Who.php"><!-- load the who's online strings... we don't use it much now, but maybe later... -->
		<operation>
			<search position="before"><![CDATA[loadLanguage('Who');]]></search>
			<add><![CDATA[
	shd_load_language('SimpleDeskWho');
	shd_load_plugin_langfiles('who');]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Errors.php"><!-- if an error occurs in an SD file, log it appropriately with the SD errortype -->
		<operation>
			<search position="after"><![CDATA[	// Make sure the category that was specified is a valid one]]></search>
			<add><![CDATA[	// Is this a SimpleDesk error?
	$known_error_types[] = 'simpledesk';
	if (strpos($file, 'SimpleDesk') !== false || strpos($error_message, 'shd_') !== false || strpos($error_message, 'SimpleDesk') !== false)
		$error_type = 'simpledesk';

]]></add>
		</operation>
	</file>

	<file name="$boarddir/index.php"><!-- set up the relevant action stuff -->
		<operation><!-- add a master override if we haven't declared an action -->
			<search position="after"><![CDATA[		// Action and board are both empty... BoardIndex!]]></search>
			<add><![CDATA[		// If we're in HD-only mode, let's run with that!
		if (!empty($modSettings['shd_helpdesk_only']) && $modSettings['helpdesk_active'])
		{
			require_once($sourcedir . '/sd_source/SimpleDesk.php');
			return 'shd_main';
		}
]]></add>
		</operation>
		<operation><!-- add a catcher in case it's a function we don't have -->
			<search position="after"><![CDATA[		// Fall through to the board index then...
		require_once($sourcedir . '/BoardIndex.php');
		return 'BoardIndex';]]></search>
			<add><![CDATA[		// If we're in HD-only mode, we can't let them go anywhere useless
		if (!empty($modSettings['shd_helpdesk_only']) && $modSettings['helpdesk_active'])
		{
			require_once($sourcedir . '/sd_source/SimpleDesk.php');
			return 'shd_main';
		}

]]></add>
		</operation>
	</file>

	<file name="$boarddir/SSI.php"><!-- Load SimpleDesk SSI functions -->
		<operation>
			<search position="before"><![CDATA[require_once($sourcedir . '/Security.php');]]></search>
			<add><![CDATA[
require_once($sourcedir . '/sd_source/SimpleDesk-SSI.php');]]></add>
		</operation>
	</file>

</modification>